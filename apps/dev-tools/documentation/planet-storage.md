# Planet-Centric Storage Architecture

This document describes the design of Ashtrail's hybrid planet storage engine, implemented to resolve file-bloat and provide a cohesive, structured backend for simulated worlds.

## Motivation
Previously, the application stored all textures in a flat `generated/textures` folder and all generated game data in a flat `generated/world-cache` directory. User-drawn regions were saved in the client browser's `localStorage`. As files accumulated, managing states, linking upscaled textures (which can exceed 20MB per image), and recovering geography data across sessions became cumbersome and prone to desync.

## Directory Structure
To solve this, we migrated to a **Planet-Centric Folder Structure**. Every time a world is generated or manually spawned, a master directory is instantiated using a UUID.

```
dev-tools/backend/generated/planets/<UUID>/
  ├─ textures/
  │   ├─ base.jpg
  │   ├─ upscaled_<hash_a>.png
  │   └─ upscaled_<hash_b>.png
  ├─ world_data.json
  ├─ geography.json
  └─ metadata.json
```

### Components

1. **`textures/`**: Contains the raw imagery generated by the initial AI request. The base image is always named `base.jpg`. Subsequent ESRGAN upscales of that image are deposited into the same texture directory.
2. **`world_data.json`**: The heavy, multi-megabyte cache of the simulated Terrain Cells, complete with generated elevations, biomes, and neighbors.
3. **`geography.json`**: A lightweight array of `GeoRegion` objects containing user-drawn or AI-generated boundaries, names, and lore descriptions. Moving this to the backend ensures the shapes are persistently linked to the planet, regardless of the browser or device used.
4. **`metadata.json`**: Acts as the manifest. Contains the `GenerationHistoryItem` data: the original prompt, tuning config, timestamp, and the pointer to the currently active texture.

## Backend APIs

The axum server exposes several routes to interact with this hierarchy:

- **Planet Discovery**: `GET /api/history` no longer reads a monolithic array. It crawls the `planets/` directory, checks for valid `metadata.json` files, and constructs a live list of available planets.
- **Geography Sync**: `/api/planet/geography/{id}` accepts GET and POST requests to serialize the `geography.json` representation.
- **Static File Serving**: The entire `planets/` tree is attached to a `ServeDir` allowing the frontend to hot-link images directly via `/api/planets/<UUID>/textures/base.jpg`.

## Frontend Gallery

Because textures are now intrinsically linked to their parent planet, the `HistoryGallery.tsx` UI was redesigned to reflect this hierarchical structure.

It features two tabs:
1. **[ PLANETS ]**: Shows the distinct seeded worlds. Clicking one loads its simulation state and geography.
2. **[ TEXTURES ]**: Selectable only when a planet is active. Shows all variants inside the `textures/` folder (base + any overpainted or upscaled options). Switching textures updates the map display without re-initializing the underlying cellular grid or destroying drawn regions.
